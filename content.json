[{"title":"Docker系列之《企业级私有仓库解决方案》","date":"2018-06-11T06:37:16.000Z","path":"2018/06/11/Docker系列之《企业级私有仓库解决方案》.html","text":"前言： Docker Hub作为Docker默认官方公共镜像，如果自己想搭建私有镜像仓库，官网也提供registry镜像，使得搭建私有仓库非常简单。 一、搭建私有镜像仓库:registry1.1、下载registry镜像并启动12$ docker pull registry$ docker run -d -v /opt/registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry 1.2、测试，查看镜像仓库中所有镜像12$ curl http://127.0.0.1:5000/v2/_catalog&#123;&quot;repositories&quot;:[]&#125; 1.3、私有镜像仓库管理1）配置私有仓库可信任1234567891011$ vim /etc/docker/daemon.json&#123;\"insecure-registries\":[\"127.0.0.1:5000\"]&#125;systemctl restart docker这里需要注意一点，如果daemon.json里已经有配置，\"需要在原有配置后面加逗号，不然失效\" 譬如：$ cat /etc/docker/daemon.json&#123; \"registry-mirrors\": [ \"https://registry.docker-cn.com\"], \"insecure-registries\": [\"172.16.194.130:5000\"]&#125; 2）打标签1$ docker tag centos:6 127.0.0.1:5000/centos:7 3）上传1$ docker push 127.0.0.1:5000/centos:7 4）下载1$ docker pull 127.0.0.1:5000/centos:7 5）列出镜像标签12$ curl http://127.0.0.1:5000/v2/centos/tags/list&#123;\"name\":\"centos\",\"tags\":[\"7\"]&#125; 注意：127.0.0.1可以换成你网卡的地址 二、Docker Hub公共镜像仓库使用因为dockerHub是国外的服务器，push和pull操作都比较慢，甚至有连接超时的情况，个人研究玩玩还是可以的。https://cloud.docker.com/swarm/nicksors 1）注册帐号https://hub.docker.com 2）登录Docker Hub12345$ docker login或$ docker login --username=nicksors --password=xxxWARNING! Using --password via the CLI is insecure. Use --password-stdin.Login Succeeded 3）镜像打标签1$ docker tag nginx:1.12 nicksors/nginx:v2 4）上传1$ docker push nicksors/nginx:v2 5）下载1$ docker pull nicksors/nginx:v2 三、基于Harbor搭建Docker私有镜像仓库（推荐:很多企业都用这个）3.1、什么是Harbor？Harbor是VMware开源的又一个Docker Registry企业级私有仓库，其项目地址为https://github.com/vmware/harbor；相比Docker公司自己提供的Registry私有镜像仓库而言，Harbor提供了更多的功能，如下： 基于角色的访问控制 - 用户与Docker镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限。 镜像复制 - 镜像可以在多个Registry实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景。 图形化用户界面 - 用户可以通过浏览器来浏览，检索当前Docker镜像仓库，管理项目和命名空间。 AD/LDAP 支持 - Harbor可以集成企业内部已有的AD/LDAP，用于鉴权认证管理。 审计管理 - 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理。 国际化 - 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来。 RESTful API - RESTful API 提供给管理员对于Harbor更多的操控, 使得与其它管理软件集成变得更容易。 部署简单 - 提供在线和离线两种安装工具， 也可以安装到vSphere平台(OVA方式)虚拟设备。 以上来自官网介绍：https://vmware.github.io/harbor/cn/ 3.2、准备环境 自己创建的虚拟机：CentOS7.2、配置是2G2C； Docker版本：Docker version 18.03.0-ce Docker-compose：docker-compose version 1.20.1 Harbor版本：harbor-offline-installer-v1.4.0.tgz 3.3、安装Harbor在安装Harbor之前，必须保证你的环境已经安装好docker和docker-compose了,这两个安装方法在Docker官网都有：12安装Docker方法：https://docs.docker.com/install/linux/docker-ce/centos安装Docker-Compose方法：https://docs.docker.com/compose/install/#install-compose 你可以在 Harbor版本https://github.com/vmware/harbor/releases 地址下载你想要装的版本，这里我选择最新的1.4.0，当然你看到的时候已经不是最新版本了。123# 选择离线安装版本$ wget https://storage.googleapis.com/harbor-releases/release-1.4.0/harbor-offline-installer-v1.4.0.tgz（如果下载慢的话，你可以使用迅雷下载，有的网友就这么干，会快很多） 解压下载的包，进入解压后的harbor目录，里面有个harbor.cfg就是配置文件啦，简单说下：这里面可以配置LDAP，数据库，邮件信息，ssl证书等。12345$ vim harbor.cfg# 我配置了两个地方，主机名和Harbor admin的密码，其他默认hostname = 172.16.194.130harbor_admin_password = abc123!! 下面奉上一份harbor.cfg的关键参数说明：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145## Configuration file of Harbor#hostname设置访问地址，可以使用ip、域名，不可以设置为127.0.0.1或localhosthostname = 172.16.194.130 #这里我使用本机IP# 访问协议，默认是http，也可以设置https，如果设置https，则nginx ssl需要设置onui_url_protocol = http#Maximum number of job workers in job servicemax_job_workers = 3#Determine whether or not to generate certificate for the registry's token.#If the value is on, the prepare script creates new root cert and private key#for generating token to access the registry. If the value is off the default key/cert will be used.#This flag also controls the creation of the notary signer's cert.customize_crt = on# 指定的证书文件，生产环境一定要使用ssl证书ssl_cert = /data/cert/server.crtssl_cert_key = /data/cert/server.key# 存放证书的路径,这个路径会挂载到宿主机的/data/目录下secretkey_path = /data#Admiral's url, comment this attribute, or set its value to NA when Harbor is standaloneadmiral_url = NA#Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated.log_rotate_count = 50#Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes.#If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G#are all valid.log_rotate_size = 200M#************************BEGIN INITIAL PROPERTIES************************# 配置邮件server信息email_identity =email_server = smtp.mydomain.comemail_server_port = 25email_username = sample_admin@mydomain.comemail_password = abcemail_from = admin &lt;sample_admin@mydomain.com&gt;email_ssl = falseemail_insecure = false# 启动Harbor后，管理员UI登录的密码，默认是Harbor12345harbor_admin_password = admin123# 认证方式，这里支持多种认证方式，如LADP、本次存储、数据库认证。默认是db_auth，mysql数据库认证auth_mode = db_auth# ldap配置ldap_url = ldaps://ldap.mydomain.com#A user's DN who has the permission to search the LDAP/AD server.#If your LDAP/AD server does not support anonymous search, you should configure this DN and ldap_search_pwd.#ldap_searchdn = uid=searchuser,ou=people,dc=mydomain,dc=com#the password of the ldap_searchdn#ldap_search_pwd = password#The base DN from which to look up a user in LDAP/ADldap_basedn = ou=people,dc=mydomain,dc=com#Search filter for LDAP/AD, make sure the syntax of the filter is correct.#ldap_filter = (objectClass=person)# The attribute used in a search to match a user, it could be uid, cn, email, sAMAccountName or other attributes depending on your LDAP/ADldap_uid = uid#the scope to search for users, 0-LDAP_SCOPE_BASE, 1-LDAP_SCOPE_ONELEVEL, 2-LDAP_SCOPE_SUBTREEldap_scope = 2#Timeout (in seconds) when connecting to an LDAP Server. The default value (and most reasonable) is 5 seconds.ldap_timeout = 5#Verify certificate from LDAP serverldap_verify_cert = true#Turn on or off the self-registration featureself_registration = on#The expiration time (in minute) of token created by token service, default is 30 minutestoken_expiration = 30# 用户创建项目权限控制，默认是everyone（所有人），也可以设置为adminonly（只能管理员）project_creation_restriction = everyone#************************END INITIAL PROPERTIES************************#######Harbor DB configuration section########The address of the Harbor database. Only need to change when using external db.db_host = mysql#The password for the root user of Harbor DB. Change this before any production use.db_password = root123#The port of Harbor database hostdb_port = 3306#The user name of Harbor databasedb_user = root##### End of Harbor DB configuration########The redis server address. Only needed in HA installation.redis_url =##########Clair DB configuration#############Clair DB host address. Only change it when using an exteral DB.clair_db_host = postgres#The password of the Clair's postgres database. Only effective when Harbor is deployed with Clair.#Please update it before deployment. Subsequent update will cause Clair's API server and Harbor unable to access Clair's database.clair_db_password = password#Clair DB connect portclair_db_port = 5432#Clair DB usernameclair_db_username = postgres#Clair default databaseclair_db = postgres##########End of Clair DB configuration#############The following attributes only need to be set when auth mode is uaa_authuaa_endpoint = uaa.mydomain.orguaa_clientid = iduaa_clientsecret = secretuaa_verify_cert = trueuaa_ca_cert = /path/to/ca.pem### Docker Registry setting ####registry_storage_provider can be: filesystem, s3, gcs, azure, etc.registry_storage_provider_name = filesystem#registry_storage_provider_config is a comma separated \"key: value\" pairs, e.g. \"key1: value, key2: value2\".#Refer to https://docs.docker.com/registry/configuration/#storage for all available configuration.registry_storage_provider_config = 3.4、启动Harbor修改完配置文件后，在的当前目录执行./install.sh，Harbor服务就会根据当期目录下的docker-compose.yml开始下载依赖的镜像，检测并按照顺序依次启动各个服务。123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293$ ./install.sh[Step 0]: checking installation environment ...Note: docker version: 18.03.0Note: docker-compose version: 1.20.1[Step 1]: loading Harbor images ...Loaded image: vmware/notary-server-photon:v0.5.1-v1.4.0Loaded image: vmware/notary-signer-photon:v0.5.1-v1.4.0Loaded image: vmware/harbor-db:v1.4.0Loaded image: vmware/clair-photon:v2.0.1-v1.4.0Loaded image: vmware/postgresql-photon:v1.4.0Loaded image: vmware/harbor-adminserver:v1.4.0Loaded image: vmware/harbor-ui:v1.4.0Loaded image: vmware/harbor-log:v1.4.0Loaded image: vmware/harbor-jobservice:v1.4.0Loaded image: vmware/nginx-photon:v1.4.0Loaded image: vmware/registry-photon:v2.6.2-v1.4.0Loaded image: vmware/photon:1.0Loaded image: vmware/mariadb-photon:v1.4.0Loaded image: vmware/harbor-db-migrator:1.4[Step 2]: preparing environment ...Clearing the configuration file: ./common/config/adminserver/envClearing the configuration file: ./common/config/ui/envClearing the configuration file: ./common/config/ui/app.confClearing the configuration file: ./common/config/ui/private_key.pemClearing the configuration file: ./common/config/db/envClearing the configuration file: ./common/config/jobservice/envClearing the configuration file: ./common/config/jobservice/app.confClearing the configuration file: ./common/config/registry/config.ymlClearing the configuration file: ./common/config/registry/root.crtClearing the configuration file: ./common/config/nginx/nginx.confClearing the configuration file: ./common/config/log/logrotate.confloaded secret from file: /data/secretkeyGenerated configuration file: ./common/config/nginx/nginx.confGenerated configuration file: ./common/config/adminserver/envGenerated configuration file: ./common/config/ui/envGenerated configuration file: ./common/config/registry/config.ymlGenerated configuration file: ./common/config/db/envGenerated configuration file: ./common/config/jobservice/envGenerated configuration file: ./common/config/log/logrotate.confGenerated configuration file: ./common/config/jobservice/app.confGenerated configuration file: ./common/config/ui/app.confGenerated certificate, key file: ./common/config/ui/private_key.pem, cert file: ./common/config/registry/root.crtThe configuration files are ready, please use docker-compose to start the service.[Step 3]: checking existing instance of Harbor ...[Step 4]: starting Harbor ...Creating harbor-log ... doneCreating harbor-db ... doneCreating registry ... doneCreating harbor-adminserver ... doneCreating harbor-ui ... doneCreating nginx ... doneCreating harbor-jobservice ... done✔ ----Harbor has been installed and started successfully.----Now you should be able to visit the admin portal at http://172.16.194.130.For more details, please visit https://github.com/vmware/harbor .# 这时候你可以通过docker-compose 或docker ps来查看Harbor依赖运行的一些容器# 当然你也可以通过docker-compose来管理这些容器$ docker-compose ps Name Command State Ports-------------------------------------------------------------------------------------------------------------------------------------harbor-adminserver /harbor/start.sh Up (healthy)harbor-db /usr/local/bin/docker-entr ... Up (healthy) 3306/tcpharbor-jobservice /harbor/start.sh Up (healthy)harbor-log /bin/sh -c /usr/local/bin/ ... Up (healthy) 127.0.0.1:1514-&gt;10514/tcpharbor-ui /harbor/start.sh Up (healthy)nginx nginx -g daemon off; Up 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:80-&gt;80/tcpregistry /entrypoint.sh serve /etc/ ... Up (healthy) 5000/tcp$ docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESbaf9d3e586f8 vmware/harbor-jobservice:v1.4.0 \"/harbor/start.sh\" About an hour ago Up About an hour (healthy) harbor-jobservice484d5c4fca4b vmware/nginx-photon:v1.4.0 \"nginx -g 'daemon of…\" About an hour ago Up About an hour 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp nginxdd7c62b45af1 vmware/harbor-ui:v1.4.0 \"/harbor/start.sh\" About an hour ago Up About an hour (healthy) harbor-uie5494bd12f64 vmware/registry-photon:v2.6.2-v1.4.0 \"/entrypoint.sh serv…\" About an hour ago Up About an hour (healthy) 5000/tcp registry915b753623b7 vmware/harbor-adminserver:v1.4.0 \"/harbor/start.sh\" About an hour ago Up About an hour (healthy) harbor-adminserver55ca16b86243 vmware/harbor-db:v1.4.0 \"/usr/local/bin/dock…\" About an hour ago Up About an hour (healthy) 3306/tcp harbor-db30ca0cb76dd0 vmware/harbor-log:v1.4.0 \"/bin/sh -c /usr/loc…\" About an hour ago Up About an hour (healthy) 127.0.0.1:1514-&gt;10514/tcp 3.5、登录Harbor启动完成后，会提示你Harbor的访问地址：http://172.16.194.130 登录界面 输入账号和我们预先设定的密码：admin/admin123 我们可以看到系统各个模块如下： 项目：新增/删除项目，查看镜像仓库，给项目添加成员、查看操作日志、复制项目等 日志：仓库各个镜像create、push、pull等操作日志 系统管理 用户管理：新增/删除用户、设置管理员等 复制管理：新增/删除从库目标、新建/删除/启停复制规则等 配置管理：认证模式、复制、邮箱设置、系统设置等 其他设置 用户设置：修改用户名、邮箱、名称信息 修改密码：修改用户密码 注意：非系统管理员用户登录，只能看到有权限的项目和日志，其他模块不可见。 3.6、向Harbor仓库中心提交私有镜像我们要尝试下能不能把自己 Docker 里面的镜像 push 到 Harbor 的 library 里来（默认这个 library 项目是公开的，所有人都可以有读的权限，都不需要 docker login 进来，就可以拉取里面的镜像）。 3.6.1、配置Docker registry仓库地址在/etc/docker/daemon.json里添加配置如下：123&#123; &quot;insecure-registries&quot;: [&quot;172.16.194.130&quot;]&#125; 配置好后，别忘了重启systemctl restart docker 3.6.2、Docker 登录Harbor为什么要登录呢？跟Docker Hub一样，你得登录才能表明你是合法用户，才能push；1234$ docker login 172.16.194.130Username: adminPassword: (这里输入harbor平台设置的admin密码)Login Succeeded 3.6.3、本地私有镜像打tag，提交到Harbor1234567891011$ docker tag tale:base 172.16.194.130/library/tale:base$ docker push 172.16.194.130/library/taleThe push refers to repository [172.16.194.130/library/tale]a3ece4722ead: Pusheded61150eb02c: Pushed0f9f3d37a459: Pushed8ed018b01f91: Pushedb17185091796: Pushedb03095563b79: Pushedbase: digest: sha256:f82f2e175479d6d232efab45f81a4495cc4ad0a48135fd839dc27fdee8c13c77 size: 1574 提交成功，我们来看看Harbor仓库里的信息 能看到已经提交到libary公共仓库中。 同理，你也可以测试下从 Harbor pull 镜像到你的 Docker 中去，操作如下：123456789$ docker rmi 172.16.194.130/library/tale:base$ docker pull 172.16.194.130/library/tale:basebase: Pulling from library/taleDigest: sha256:f82f2e175479d6d232efab45f81a4495cc4ad0a48135fd839dc27fdee8c13c77Status: Downloaded newer image for 172.16.194.130/library/tale:base$ docker images REPOSITORY TAG IMAGE ID CREATED SIZE172.16.194.130/library/tale base ab8e3ca33cd0 5 days ago 372MB 镜像在被我删除后，从Harbor里成功pull了回来。 3.7、Harbor配置ssl认证3.7.1、创建证书1$ cd /data/cert/ 1、创建 CA 根证书1$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj &quot;/C=CN/L=xian/O=nova/CN=harbor-registry&quot; 2、生成一个证书签名, 设置访问域名为harbor.moxiu.cn1$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout harbor.moxiu.cn.key -out server.csr -subj &quot;/C=CN/L=xian/O=nova/CN=harbor.moxiu.cn&quot; 3、生成主机的证书1$ openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out harbor.moxiu.cn.crt 3.7.2、配置harbor以https方式访问12345$ vim harbor.cfghostname = harbor.moxiu.cn:443ui_url_protocol = httpsssl_cert = /data/cert/harbor.moxiu.cn.crtssl_cert_key = /data/cert/harbor.moxiu.cn.key 3.7.3、配置Docker registry仓库地址在/etc/docker/daemon.json里添加配置如下：123&#123; \"insecure-registries\": [\"harbor.moxiu.cn\"]&#125; 然后，重启docker服务生效 3.7.4、登录验证1、验证admin登录方法11234$ docker login harbor.moxiu.cnUsername (admin): adminPassword: Login Succeeded 2、验证admin登录方法212$ docker login -u admin -p abc123!! harbor.moxiu.cnLogin Succeeded 3、Web页面登录验证http://harbor.moxiu.cn/harbor/sign-in用户名/密码：admin/abc123!! 因为不是有效机构颁发的证书，所有浏览器会提示不安全。如果企业需要使用，那需要买商用的证书更换即可。","tags":[{"name":"harbor","slug":"harbor","permalink":"//nicksors.cc/tags/harbor/"},{"name":"registry","slug":"registry","permalink":"//nicksors.cc/tags/registry/"}]},{"title":"Zabbix系列之《监控TCP连接状态》","date":"2018-06-08T09:07:18.000Z","path":"2018/06/08/Zabbix系列之《监控TCP连接状态》.html","text":"前言：在运维工作中，服务器的TCP连接情况一致是关注的范畴，TCP活跃连接突然增高？是什么原因导致？机器被黑了？web业务流量上来了？谁知道呢… 今天为大家介绍zabbix监控服务器的TCP连接状态，看完本文你将学到如下知识： 撰写zabbix自定义监控key和如何使用自定义脚本； 学会自己创建模板，并在模板里创建一个图表； 效果展示 服务器的TCP连接通过zabbix监控并用上面的图表呈现出来，可以横向与历史数据进行对比，一眼看出当前值是否正常。这个图表是自己创建的，下面有创建的方法。 那么我们接下来就开始学习之旅~ 客户端撰写自定义脚本我使用shell写了一个脚本，便于获取TCP的各种状态的值12345678[root@adminset ~]# sh tcp.sh total91[root@adminset ~]# sh tcp.sh ESTABLISHED41[root@adminset ~]# sh tcp.sh TIME_WAIT51[root@adminset ~]# sh tcp.sh CLOSE_WAIT0 脚本内容如下：vim tcp.sh123456789101112131415#!/bin/bash#获取各种状态连接数if [[ \"$1\" = \"\" || \"$1\" = \"total\" ]]then netstat -n |grep 'tcp'|wc -l exit 0;fistr=`netstat -n | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'|grep $1`if [[ \"$str\" = \"\" ]]then echo 0;else echo $str|awk '&#123;print $2&#125;'fi 把此文件存放到/usr/lib/zabbix/externalscripts/里(没有的话创建)，然后给与755权限，并修改用户与组为zabbix，同时允许zabbix用户无密码运行netstat12echo \"zabbix ALL=(root) NOPASSWD:/bin/netstat\"&gt;&gt;/etc/sudoerssed -i 's/^Defaults.*.requiretty/#Defaults requiretty/' /etc/sudoers #不关闭的话，会无法获取数据，并且zabbix日志里报 创建自定义key在Zabbix系列之《安装Agent客户端并添加主机监控》一文里写到zabbix_agent.conf配置文件中，Include参数包含了/etc/zabbix/zabbix_agentd.d/*.conf这个目录下所有以.conf结尾的文件。 在/etc/zabbix/zabbix_agentd.d/目录里创建tcp.conf文件，写入下面内容：12# tcp连接数UserParameter=netstat.conn[*], /usr/lib/zabbix/externalscripts/tcp.sh $1 关于zabbix 自定义key的写法，这里没法展开说明，还请善用搜索框和官网。 测试在测试前，需要重启客户端程序，加载刚添加的配置1systemctl restart zabbix-agent 我的测试结果：123456[root@adminset ~]# zabbix_get -s 172.16.194.128 -p 10050 -k \"netstat.conn[total]\"83[root@adminset ~]# zabbix_get -s 172.16.194.128 -p 10050 -k \"netstat.conn[ESTABLISHED]\"44[root@adminset ~]# zabbix_get -s 172.16.194.128 -p 10050 -k \"netstat.conn[CLOSE_WAIT]\"0 如果你能通过zabbix_get命令获取到值，说明你的客户端配置完全没问题了，接下来就是服务端添加监控。什么？你没有zabbix_get命令？天啦！请查看：解决方法 服务端创建模板1、创建一个名为“Template OS Netstat”的模板点击 【Configuration】–&gt;【Templates】–&gt;【Create templateImport】点击Add添加。 2、创建一个名为“Netstat”的Applications点击刚创建的模板，【Applications】–&gt;【Create application】 3、创建ITEMS(监控项)创建一个item 创建好的items上面所有的items都是一个一个加上去的，如果你要自己制作模板，就得这么干！除此之外别无他法。 4、创建Graphs（图表）点击 【Graphs】–&gt;【Create graph】 到这里，整个创建模板的过程就算完成了。 模板导入如果你嫌上面的步骤麻烦，只是想使用这个模板的话，这里提供了一种便捷的方法：我将上面制作的模板导出，并提供你下载。 请点击下载：Template OS Netstat模板，下载后在你的zabbix里导入该模板即可。 主机关联模板把需要监控的主机添加模板关联即可监控 本文讲解了如何自定义脚本和key，并且通过案例演示了创建模板的过程，以及提供创建的模板给大家，今后在工作中自己也可以尝试着做模板，一方面为了自己学习，另一方面自己做的模板给他人使用，你会有成就感。 好了，本文就到这，如果你在阅读或使用文章中遇到问题，欢迎加入QQ群：32330026，我们是一群爱学习的人，期待与你一起学习进步。","tags":[{"name":"netstat","slug":"netstat","permalink":"//nicksors.cc/tags/netstat/"},{"name":"TCP","slug":"TCP","permalink":"//nicksors.cc/tags/TCP/"}]},{"title":"Zabbix系列之《安装Agent客户端并添加主机监控》","date":"2018-06-07T09:46:29.000Z","path":"2018/06/07/Zabbix系列之《安装Agent客户端并添加主机监控》.html","text":"前言：上一片文章讲解了如何快速安装zabbix，本文将介绍安装zabbix和增加一个主机监控的细节，不足之处还望指出。 安装ZabbixAgent使用yum快速安装1yum install zabbix-agent 修改配置文件123find / -name &apos;*zabbix_agentd.conf*&apos;# /etc/zabbix/zabbix_agentd.confcp /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak 修改相关具体项123456789# vim /etc/zabbix/zabbix_agentd.confPidFile=/var/run/zabbix/zabbix_agentd.pidLogFile=/var/log/zabbix/zabbix_agentd.logLogFileSize=0Server=zabbix_server_IP zabbix服务器ip地址ServerActive=zabbix_server_IP 主动向zabbix server发送监控内容Hostname=Monitor_host agent节点的host主机名，在添加监控的时候要与这个名称一致UnsafeUserParameters=1 是否启用自定义key,zabbix监控mysql、tomcat等数据时需要自定义keyInclude=/etc/zabbix/zabbix_agentd.d/*.conf 启动客户端1# systemctl start zabbix-agent 开机自启动1# systemctl enable zabbix-agent 服务器添加被监控主机截至目前，已经安装好了zabbix server和zabbix agent，那接下来添加一台监控主机作为演示，帮助大家认识zabbix是如何监控服务器的。 登陆 http://zabbix_server_ip/zabbix, 点击 【Configuration】-&gt;【Hosts】-&gt;【Create host】 添加模板 模板添加完成后，回到Host页，然后点击页面下方的“add”按钮，即添加完成。 监控列表如下，你添加的所有主机监控，都将会在下方显示：绿色的“ZBX”字样表示已成功通过zabbix agent对其进行监控，当然还有其他方式进行监控，如SNMP方式等。 整个Dashboard监控页面显示如下显示有一个监控异常 查看图表点击【Monitoring】-&gt;【Graphs】-&gt;【Group】-&gt;【Host】-&gt; 【Graph】（可以选择你关心的查看） 到这里，我们完成了如何安装zabbix，以及部署、添加监控等信息。也有了详细的示例演示，希望能帮助你对zabbix有个初步的认识，后续文章，敬请持续关注。","tags":[{"name":"Zabbix","slug":"Zabbix","permalink":"//nicksors.cc/tags/Zabbix/"}]},{"title":"Zabbix系列之《CentOS7快速安装Zabbix3-4》","date":"2018-06-03T02:16:29.000Z","path":"2018/06/03/Zabbix系列之《CentOS7快速安装Zabbix3-4》.html","text":"前言：Zabbix系列文章是实战操作为主的文章，这个系列文章设计从入门实战到深度使用，以及后面呈现一些高阶的玩法，带领运维同学搞定企业监控。 这篇文章适合刚入行的运维同学，在运维领域学习技术最好的方式就是：先快速将它搭建起来，然后根据每个组件或知识点横向深入学习，这也是最佳实践，本文就是带领运维童鞋们快速安装和掌握监控领域的利器，zabbix！ 系统环境准备在安装zabbix之前，你需要对系统做一个简单的初始化工作，这是zabbix能否正常运行的必备条件。 关闭selinux永久关闭123# vi /etc/selinux/configSELINUX=disabledSELINUXTYPE=targeted 临时关闭1setenforce 0 关闭防火墙永久关闭12systemctl stop firewalld.service #停止firewallsystemctl disable firewalld.service #禁止firewall开机启动 临时生效1iptables -F 配置系统时间同步设置每隔20分钟同步一次1*/20 * * * * ntpdate -u asia.pool.ntp.org &gt;/dev/null 2&gt;&amp;1 选择你需要的版本进行安装你打开zabbix官网会发现，zabbix安装页面提供了非常详细的条件供你选择，能适应主流Linux发行版的需求。 如题，我使用的是CentOS7.2版本，那么我选择的最佳实践就是通过yum安装，如果你没有那么高的定制需求，建议使用此方法。当然如果有特定需求或规范，你也可以选择源码编译安装。 如上，是我选择的版本信息。 安装和初始化安装zabbix1、CentOS7的yum源里默认不能安装zabbix，这使得zabbix自己提供了一个repo源，我们需要安装下：1# rpm -i http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm 2、安装zabbix-server以及必要的一些包1# yum install zabbix-server-mysql zabbix-web-mysql 安装数据库1、CentOS7默认安装MariaDB，值得说一下的是，MariaDB与MySQL在使用上没有区别，咱们正常使用即可。 快速安装数据库：123456789101112131415161718# yum -y install mariadb mariadb-server# systemctl start mariadb# systemctl enable mariadb# 初始化数据库# mysql_secure_installation &lt;== 会有很多提示，一路回车即可# 登录数据库[root@nicksors ~]# mysqlWelcome to the MariaDB monitor. Commands end with ; or \\g.Your MariaDB connection id is 412Server version: 5.5.56-MariaDB MariaDB ServerCopyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.MariaDB [(none)]&gt; 2、创建初始数据库12345# mysql &lt;==进入数据库，并执行下面几条SQL语句mysql&gt; create database zabbix character set utf8 collate utf8_bin; &lt;==创建一个数据库，名称为zabbixmysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by 'password'; &lt;==创建用户，并设置权限和密码mysql&gt; quit; 导入初始化数据库1# zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix 给zabbix-server做一些配置1、首先你得告诉zabbix_server，你的数据库密码是什么？编辑 /etc/zabbix/zabbix_server.conf文件，修改如下：1DBPassword=123123 （我设置的密码是123123，你自己设置的多少，填写到这里） 2、配置php的时间区域编辑/etc/httpd/conf.d/zabbix.conf文件，取消下面这一行的注释1# php_value date.timezone Asia/Shanghai &lt;==如果你是中国大陆用户，请设置时间区域为“亚洲/上海” 启动zabbix_server 和zabbix_agent进程1、启动12# systemctl restart zabbix-server httpd# systemctl enable zabbix-server httpd 2、启动后保持检查的好习惯：1234[root@nicksors ~]# netstat -lntup|egrep \"zabbix|http\"tcp 0 0 0.0.0.0:10051 0.0.0.0:* LISTEN 23022/zabbix_servertcp6 0 0 :::80 :::* LISTEN 23205/httpdtcp6 0 0 :::10051 :::* LISTEN 23022/zabbix_server zabbix_server端口默认为10051 zabbix_agent端口默认为10050 3、访问地址为：http://server_ip_or_name/zabbix请将server_ip_or_name换成你的主机IP地址 Web页面配置zabbix点击Next step 这一步如果有“红叉”的，你需要满足，自行百度可以解决。点击Next step 默认会选择MySQL，port填写3306，Password填写你设置的密码即可。点击Next step 设置Zabbix Server信息，默认即可，Name写不写随你。点击Next step 你的配置总览。点击Next step 告诉你已经配置成功，配置文件在/etc/zabbix/web/zabbix.conf.php文件里，今后有变动需要更改配置，在这个文件更改就行。点击Finish跳转至登录页面 默认用户名密码：Admin/zabbix Zabbix Dashboard 到这里就完成了zabbix的安装部署啦，后续文章，敬请持续关注。","tags":[{"name":"Zabbix","slug":"Zabbix","permalink":"//nicksors.cc/tags/Zabbix/"},{"name":"CentOS","slug":"CentOS","permalink":"//nicksors.cc/tags/CentOS/"}]}]